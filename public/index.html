<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
<title>–°–æ—é–∑–º—É–ª—å—Ç–ø–∞—Ä–∫ ‚Äî –í–æ–ª—à–µ–±–Ω—ã–π AR‚Äë–æ–±—ä–µ–∫—Ç–∏–≤</title>
<link rel="stylesheet" href="./styles.css" />
<!-- A‚ÄëFrame & MindAR -->
<script src="https://unpkg.com/aframe@1.6.0/dist/aframe.min.js"></script>
<script src="https://unpkg.com/mind-ar/dist/mindar-image-aframe.prod.js"></script>
</head>
<body>
    <!-- –û–≤–µ—Ä–ª–µ–π –ø–æ–¥—Å–∫–∞–∑–æ–∫ -->
<div id="hint" class="overlay hidden"></div>
<!-- –ö–Ω–æ–ø–∫–∏ UI -->
<div id="ui" class="ui">
<button id="btn-help" aria-label="–ü–æ–º–æ—â—å">?</button>
<button id="btn-snap" aria-label="–°–Ω–∏–º–æ–∫">üì∏ –°–Ω–∏–º–æ–∫</button>
<button id="btn-selfie" aria-label="–°–µ–ª—Ñ–∏-—Ä–µ–∂–∏–º">ü§≥ –°–µ–ª—Ñ–∏</button>
<button id="btn-ticket" aria-label="–ö—É–ø–∏—Ç—å –±–∏–ª–µ—Ç—ã" onclick="location.href='ticket.html'">üéüÔ∏è –ë–∏–ª–µ—Ç—ã</button>
</div>
<!-- –û–≤–µ—Ä–ª–µ–π ¬´–ü–æ–≤–µ—Ä–Ω–∏—Ç–µ —Ç–µ–ª–µ—Ñ–æ–Ω¬ª -->
<div id="rotate" class="rotate hidden">–ü–æ–≤–µ—Ä–Ω–∏—Ç–µ —Ç–µ–ª–µ—Ñ–æ–Ω –≤ –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã–π —Ä–µ–∂–∏–º</div>
<!-- –û–≤–µ—Ä–ª–µ–π —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–π –Ω–∞ iOS (–∑–≤—É–∫/–∫–∞–º–µ—Ä–∞) -->
<div id="ios-gate" class="gate hidden">
<p>–ù–∞–∂–º–∏—Ç–µ, —á—Ç–æ–±—ã –≤–∫–ª—é—á–∏—Ç—å –∫–∞–º–µ—Ä—É –∏ –∑–≤—É–∫</p>
<button id="ios-allow">–í–∫–ª—é—á–∏—Ç—å</button>
</div>
<!-- <div id="preloader" class="preloader">–ó–∞–≥—Ä—É–∂–∞–µ–º AR‚Ä¶</div> -->
<a-scene
  mindar-image="imageTargetSrc: ./targets/targets.mind; filterMinCF:0.0002; filterBeta:0.001; warmupTolerance:5"
  embedded
  vr-mode-ui="enabled:false"
  device-orientation-permission-ui="enabled:true"
  renderer="alpha:true; colorManagement:true; physicallyCorrectLights:true; antialias:true"
>
<a-assets timeout="20000">
<!-- –ú–æ–¥–µ–ª–∏ -->
<a-asset-item id="mdl-oranges" src="./models/oranges.glb"></a-asset-item>
<a-asset-item id="mdl-lariska" src="./models/lariska.glb"></a-asset-item>
<a-asset-item id="mdl-hare" src="./models/hare.glb"></a-asset-item>
<a-asset-item id="mdl-moped" src="./models/moped.glb"></a-asset-item>
</a-assets>


<!-- –°–≤–µ—Ç ‚Üí –ø—Ä–æ—Å—Ç–æ–π –∏ –±—ã—Å—Ç—Ä—ã–π -->
<a-entity light="type: ambient; intensity: 0.9"></a-entity>
<a-entity light="type: directional; intensity: 0.8" position="0 1 0"></a-entity>


<!-- –ß–ï–ë–£–†–ê–®–ö–ê: –¥–æ–∂–¥—å –∏–∑ –∞–ø–µ–ª—å—Å–∏–Ω–æ–≤ + –ª—ë–≥–∫–∏–µ –≤—Å–ø–ª–µ—Å–∫–∏ –ø—Ä–∏ –ø–æ–ø–∞–¥–∞–Ω–∏–∏ -->
<a-entity id="tgt-cheb" mindar-image-target="targetIndex: 0">
<a-entity id="orange-root" position="0 0 0"></a-entity>
<a-entity id="orange-rain" position="0 1 0"></a-entity>
</a-entity>


<!-- –®–ê–ü–û–ö–õ–Ø–ö/–ì–ï–ù–ê: –õ–∞—Ä–∏—Å–∫–∞ —Å–∞–¥–∏—Ç—Å—è –Ω–∞ –ø–ª–µ—á–æ (—Å—Ç–∞—Ç–∏—á–Ω–æ, —É —Å–∫—É–ª—å–ø—Ç—É—Ä—ã ‚Äî —Ä—è–¥–æ–º) -->
<a-entity id="tgt-shapo" mindar-image-target="targetIndex: 1">
<a-gltf-model id="lariska-model" src="#mdl-lariska" position="0.1 0.6 0.05" rotation="0 15 0" scale="0.35 0.35 0.35" animation-mixer></a-gltf-model>
</a-entity>


<!-- –í–û–õ–ö –ù–ê –°–ö–ê–ú–ï–ô–ö–ï: –∑–∞—è—Ü –∏ (–ø–æ –Ω–∞–∂–∞—Ç–∏—é) –º–æ–ø–µ–¥ -->
<a-entity id="tgt-volk" mindar-image-target="targetIndex: 2">
<a-gltf-model id="hare-model" src="#mdl-hare" position="0.35 0 0.05" rotation="0 -20 0" scale="0.6 0.6 0.6" animation-mixer></a-gltf-model>
<a-gltf-model id="moped-model" src="#mdl-moped" position="-0.4 0 0" rotation="0 20 0" scale="0.45 0.45 0.45" visible="false"></a-gltf-model>
</a-entity>


<a-camera position="0 0 0"></a-camera>
</a-scene>
<script src="./js/capture.js"></script>
<script src="./js/ui.js"></script>
<script>
const $ = sel => document.querySelector(sel);
const rnd=(a,b)=>a+Math.random()*(b-a);


// –ü–æ–¥—Å–∫–∞–∑–∫–∏ –ø–æ —Ü–µ–ª–∏
const hint = $('#hint');
const showHint = (text)=>{ hint.textContent=text; hint.classList.remove('hidden'); };
const hideHint = ()=> hint.classList.add('hidden');


// –°–û–ë–´–¢–ò–Ø MindAR: targetFound/targetLost
const bindTarget = (el, {onFound, onLost, name, tip}) => {
el.addEventListener('targetFound', () => { showHint(tip||name); onFound&&onFound(); });
el.addEventListener('targetLost', () => { hideHint(); onLost&&onLost(); });
};


// –ß–ï–ë–£–†–ê–®–ö–ê ‚Üí –∞–ø–µ–ª—å—Å–∏–Ω–æ–≤—ã–π –¥–æ–∂–¥—å
const orangeContainer = $('#orange-rain');
let rainTimer=null;
function spawnOrange(){
const o=document.createElement('a-sphere');
o.setAttribute('radius', rnd(0.04,0.08));
o.setAttribute('position', `${rnd(-0.5,0.5)} ${rnd(0.8,1.4)} ${rnd(-0.4,0.4)}`);
o.setAttribute('material','color: orange; metalness:0.05; roughness:0.9');
const dur= rnd(1600,2600);
o.setAttribute('animation__fall', `property: position; to: ${o.getAttribute('position').split(' ')[0]} -0.5 0; dur: ${dur}; easing: linear; loop: false`);
o.addEventListener('animationcomplete__fall', ()=> o.remove());
orangeContainer.appendChild(o);
}
bindTarget($('#tgt-cheb'),{
name:'–ß–µ–±—É—Ä–∞—à–∫–∞', tip:'–ß–µ–±—É—Ä–∞—à–∫–∞ ‚Äî –ª–æ–≤–∏—Ç–µ –∞–ø–µ–ª—å—Å–∏–Ω–∫–∏! üçä',
onFound(){ rainTimer=setInterval(spawnOrange, 280); },
onLost(){ clearInterval(rainTimer); rainTimer=null; orangeContainer.innerHTML=''; }
});


// –®–ê–ü–û–ö–õ–Ø–ö ‚Üí –õ–∞—Ä–∏—Å–∫–∞ –ø–æ–∫–∞—á–∏–≤–∞–µ—Ç –≥–æ–ª–æ–≤–æ–π –ø—Ä–∏ —Ç–∞–ø–µ
const lariska = $('#lariska-model');
lariska.addEventListener('click', ()=>{
lariska.setAttribute('animation__wave','property: rotation; to: 0 45 0; dir: alternate; dur: 350; loop: 4; easing: easeInOutSine');
setTimeout(()=> lariska.removeAttribute('animation__wave'), 1500);
});
bindTarget($('#tgt-shapo'),{
name:'–®–∞–ø–æ–∫–ª—è–∫', tip:'–õ–∞—Ä–∏—Å–∫–∞ —Ä—è–¥–æ–º ‚Äî –Ω–∞–∂–º–∏, —á—Ç–æ–±—ã –ø–æ–º–∞—Ö–∞–ª–∞ üê≠',
onFound(){ /* –º–æ–∂–Ω–æ —Å—Ç–∞—Ä—Ç–æ–≤–∞—Ç—å idle‚Äë–∞–Ω–∏–º–∞—Ü–∏—é */ },
onLost(){ }
});


// –í–û–õ–ö ‚Üí –ø–æ —Ç–∞–ø—É –≤–∫–ª—é—á–∞–µ–º/–≤—ã–∫–ª—é—á–∞–µ–º –º–æ–ø–µ–¥, –∑–∞—è—Ü —Å–ª–µ–≥–∫–∞ –ø–æ–¥–ø—Ä—ã–≥–∏–≤–∞–µ—Ç
const moped=$('#moped-model');
const hare=$('#hare-model');
hare.addEventListener('click',()=>{
hare.setAttribute('animation__hop','property: position; to: 0.35 0.12 0.05; dir: alternate; dur: 250; loop: 2; easing:easeOutQuad');
setTimeout(()=>hare.removeAttribute('animation__hop'), 600);
});
document.body.addEventListener('click', (e)=>{
// –¢–æ–≥–≥–ª –º–æ–ø–µ–¥–∞ –∫–Ω–æ–ø–∫–æ–π ¬´?¬ª –Ω–µ —Ç—Ä–æ–≥–∞–µ–º; –≤—Å–µ –∫–ª–∏–∫–∏ –≤ —Å—Ü–µ–Ω–µ ‚Äî –≤–∫–ª—é—á–∞—é—Ç –º–æ–ø–µ–¥, –µ—Å–ª–∏ —Ç–∞—Ä–≥–µ—Ç –∞–∫—Ç–∏–≤–µ–Ω
if (document.activeElement && document.activeElement.closest('#ui')) return;
if (!moped) return;
moped.setAttribute('visible', !JSON.parse(moped.getAttribute('visible')));
});
bindTarget($('#tgt-volk'),{
name:'–í–æ–ª–∫', tip:'–ó–∞—è—Ü –∑–¥–µ—Å—å! –¢–∫–Ω–∏ ‚Äî –∞ –æ–Ω –ø–æ–¥–ø—Ä—ã–≥–Ω–µ—Ç üêá',
onFound(){ }, onLost(){ moped.setAttribute('visible', false); }
});


// –°–µ–ª—Ñ–∏‚Äë—Ä–µ–∂–∏–º ‚Üí –æ—Ç–¥–µ–ª—å–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ (face tracking)
document.getElementById('btn-selfie').onclick = ()=> location.href='face.html';


// –†–æ—Ç–∞—Ü–∏—è/–æ—Ä–∏–µ–Ω—Ç–∞—Ü–∏—è
const rotate = $('#rotate');
const onResize=()=>{ const p=window.matchMedia('(orientation: portrait)').matches; rotate.classList.toggle('hidden', p); };
addEventListener('resize', onResize); onResize();


// iOS –∞—É–¥–∏–æ‚Äë–≥–µ–π—Ç (–ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –≤ Safari iOS)
const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
const isSafari = /^((?!chrome|android).)*safari/i.test(navigator.userAgent);
const gate = $('#ios-gate');
if (isIOS && isSafari) gate.classList.remove('hidden');
$('#ios-allow').onclick = ()=>{ gate.classList.add('hidden'); document.getElementById('sfx-pop')?.play?.(); };


// –ü–æ–¥—Å–∫–∞–∑–∫–∞ –ø–æ query (?s=cheb|shapo|volk)
const s = new URLSearchParams(location.search).get('s');
if (s==='cheb') showHint('–ü–æ–¥–æ–π–¥–∏—Ç–µ –∫ —Å–∫—É–ª—å–ø—Ç—É—Ä–µ –ß–µ–±—É—Ä–∞—à–∫–∏ –∏ –Ω–∞–≤–µ–¥–∏—Ç–µ –∫–∞–º–µ—Ä—É');
if (s==='shapo') showHint('–ù–∞–≤–µ–¥–∏—Ç–µ –Ω–∞ –®–∞–ø–æ–∫–ª—è–∫/–ì–µ–Ω—É ‚Äî –ø–æ—è–≤–∏—Ç—Å—è –õ–∞—Ä–∏—Å–∫–∞');
if (s==='volk') showHint('–ù–∞–π–¥–∏—Ç–µ –í–æ–ª–∫–∞ –Ω–∞ —Å–∫–∞–º–µ–π–∫–µ ‚Äî —Ä—è–¥–æ–º –ø–æ—è–≤–∏—Ç—Å—è –ó–∞—è—Ü');


</script>
</body>

</html>
