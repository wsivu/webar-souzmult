<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, user-scalable=no" />
  <title>–°–æ—é–∑–º—É–ª—å—Ç–ø–∞—Ä–∫ ‚Äî AR</title>
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 64 64%22><text y=%2250%25%22 x=%2250%25%22 dominant-baseline=%22middle%22 text-anchor=%22middle%22 font-size=%2248%22>üéüÔ∏è</text></svg>">

  <style>
    html,body{margin:0;padding:0;height:100%;overflow:hidden;background:transparent;font-family:system-ui,-apple-system,Arial}
    .ui{position:fixed;left:0;right:0;bottom:16px;display:flex;gap:10px;justify-content:center;z-index:10}
    .ui button{padding:10px 14px;border:none;border-radius:12px;background:rgba(0,0,0,.6);color:#fff;font-weight:600;backdrop-filter:blur(6px)}
    .overlay{position:fixed;top:12px;left:50%;transform:translateX(-50%);background:rgba(0,0,0,.55);color:#fff;padding:10px 14px;border-radius:12px;z-index:10;font-weight:700}
    .hidden{display:none !important}
    .pre{position:fixed;inset:0;display:grid;place-items:center;background:#000;color:#fff;z-index:20;font-weight:800}
    .gate{position:fixed;inset:0;display:grid;place-items:center;background:rgba(0,0,0,.86);color:#fff;z-index:25;text-align:center;padding:24px}
    .gate .row{display:flex;gap:12px;justify-content:center;margin-top:10px}
    .gate button{padding:12px 16px;border:none;border-radius:12px;background:#1a1a1a;color:#fff;font-weight:800}

    /* —Å—Ü–µ–Ω–∞ –∏ –∫–∞–Ω–≤–∞—Å –ø–æ–≤–µ—Ä—Ö –≤–∏–¥–µ–æ */
    a-scene, a-scene canvas { position:fixed; inset:0; }
    a-scene canvas { z-index:1; background:transparent !important; }

    /* –æ—Ç–∫–ª—é—á–∞–µ–º MindAR UI */
    .mindar-ui-overlay,.mindar-ui-scanning,.mindar-ui-loading{display:none !important;opacity:0 !important;visibility:hidden !important}
  </style>

  <!-- A-Frame 1.2.0 -->
  <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
  <!-- MindAR 1.1.5 -->
  <script src="https://unpkg.com/mind-ar@1.1.5/dist/mindar-image.prod.js"></script>
  <script src="https://unpkg.com/mind-ar@1.1.5/dist/mindar-image-aframe.prod.js"></script>
</head>
<body>
  <div id="pre" class="pre">–ó–∞–≥—Ä—É–∂–∞–µ–º AR‚Ä¶</div>

  <div id="gate" class="gate">
    <div>
      <h2>–í–∫–ª—é—á–∏—Ç—å –∫–∞–º–µ—Ä—É</h2>
      <div class="row">
        <button id="start-back">–ó–∞–¥–Ω—è—è</button>
        <button id="start-front">–§—Ä–æ–Ω—Ç–∞–ª—å–Ω–∞—è</button>
      </div>
      <p style="opacity:.8;margin-top:10px">–ï—Å–ª–∏ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç ‚Äî –≤—ã–±–µ—Ä–∏—Ç–µ –¥—Ä—É–≥–æ–π —Ä–µ–∂–∏–º –∏ –∑–∞–∫—Ä–æ–π—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è/–≤–∫–ª–∞–¥–∫–∏ —Å –∫–∞–º–µ—Ä–æ–π.</p>
    </div>
  </div>

  <div id="hint" class="overlay hidden"></div>

  <div id="ui" class="ui">
    <button id="btn-help">?</button>
    <button id="btn-snap" disabled>üì∏ –°–Ω–∏–º–æ–∫</button>
    <button id="btn-ticket" onclick="location.href='ticket.html'">üéüÔ∏è –ë–∏–ª–µ—Ç—ã</button>
  </div>

  <a-scene
    renderer="alpha:true; physicallyCorrectLights:false; antialias:true"
    embedded
    vr-mode-ui="enabled:false"
    device-orientation-permission-ui="enabled:true"
    mindar-image="autoStart:false; imageTargetSrc: ./targets/targets.mind;
                  uiLoading:false; uiScanning:false;
                  /* mobile stability tweaks: */
                  filterMinCF:0.00005; filterBeta:0.001;
                  warmupTolerance:4; missTolerance:12; maxTrack:1"
    loading-screen="enabled:false"
  >
    <a-entity light="type: ambient; intensity: 1.1"></a-entity>
    <a-entity light="type: directional; intensity: 0.9" position="0 1 0"></a-entity>

    <!-- ===== –®–ê–ü–û–ö–õ–Ø–ö: 0,1,2 ===== -->
    <a-entity id="shapo-0" mindar-image-target="targetIndex: 0" position="0 0 0.04">
      <a-plane class="dbg" width="0.6" height="0.4" color="#6c5ce7" material="opacity:0.75; transparent:true; side:double"></a-plane>
      <a-cone class="lariska" radius-bottom="0.12" height="0.25" color="#fff" position="0 0.25 0.05"></a-cone>
    </a-entity>
    <a-entity id="shapo-1" mindar-image-target="targetIndex: 1" position="0 0 0.04">
      <a-plane class="dbg" width="0.6" height="0.4" color="#6c5ce7" material="opacity:0.75; transparent:true; side:double"></a-plane>
      <a-cone class="lariska" radius-bottom="0.12" height="0.25" color="#fff" position="0 0.25 0.05"></a-cone>
    </a-entity>
    <a-entity id="shapo-2" mindar-image-target="targetIndex: 2" position="0 0 0.04">
      <a-plane class="dbg" width="0.6" height="0.4" color="#6c5ce7" material="opacity:0.75; transparent:true; side:double"></a-plane>
      <a-cone class="lariska" radius-bottom="0.12" height="0.25" color="#fff" position="0 0.25 0.05"></a-cone>
    </a-entity>

    <!-- ===== –ß–ï–ë–£–†–ê–®–ö–ê: 3,4 ===== -->
    <a-entity id="cheb-3" mindar-image-target="targetIndex: 3" position="0 0 0.04">
      <a-plane class="dbg" width="0.6" height="0.4" color="#e67e22" material="opacity:0.75; transparent:true; side:double"></a-plane>
      <a-entity class="orange-rain" position="0 0.7 0"></a-entity>
    </a-entity>
    <a-entity id="cheb-4" mindar-image-target="targetIndex: 4" position="0 0 0.04">
      <a-plane class="dbg" width="0.6" height="0.4" color="#e67e22" material="opacity:0.75; transparent:true; side:double"></a-plane>
      <a-entity class="orange-rain" position="0 0.7 0"></a-entity>
    </a-entity>

    <!-- ===== –ì–ï–ù–ê: 5,6 ===== -->
    <a-entity id="gena-5" mindar-image-target="targetIndex: 5" position="0 0 0.04">
      <a-plane class="dbg" width="0.6" height="0.4" color="#2ecc71" material="opacity:0.75; transparent:true; side:double"></a-plane>
      <a-entity class="notes"></a-entity>
    </a-entity>
    <a-entity id="gena-6" mindar-image-target="targetIndex: 6" position="0 0 0.04">
      <a-plane class="dbg" width="0.6" height="0.4" color="#2ecc71" material="opacity:0.75; transparent:true; side:double"></a-plane>
      <a-entity class="notes"></a-entity>
    </a-entity>

    <!-- ===== –í–û–õ–ö: 7,8,9,10 ===== -->
    <a-entity id="volk-7"  mindar-image-target="targetIndex: 7" position="0 0 0.04">
      <a-plane class="dbg" width="0.6" height="0.4" color="#00b894" material="opacity:0.75; transparent:true; side:double"></a-plane>
      <a-box class="hare" width="0.18" height="0.21" depth="0.12" color="#2ecc71" position="0.35 0.12 0.05"></a-box>
      <a-torus-knot class="moped" p="2" q="3" radius="0.18" radius-tubular="0.03" color="#fff" position="-0.35 0.12 0" visible="false"></a-torus-knot>
    </a-entity>
    <a-entity id="volk-8"  mindar-image-target="targetIndex: 8" position="0 0 0.04">
      <a-plane class="dbg" width="0.6" height="0.4" color="#00b894" material="opacity:0.75; transparent:true; side:double"></a-plane>
      <a-box class="hare" width="0.18" height="0.21" depth="0.12" color="#2ecc71" position="0.35 0.12 0.05"></a-box>
      <a-torus-knot class="moped" p="2" q="3" radius="0.18" radius-tubular="0.03" color="#fff" position="-0.35 0.12 0" visible="false"></a-torus-knot>
    </a-entity>
    <a-entity id="volk-9"  mindar-image-target="targetIndex: 9" position="0 0 0.04">
      <a-plane class="dbg" width="0.6" height="0.4" color="#00b894" material="opacity:0.75; transparent:true; side:double"></a-plane>
      <a-box class="hare" width="0.18" height="0.21" depth="0.12" color="#2ecc71" position="0.35 0.12 0.05"></a-box>
      <a-torus-knot class="moped" p="2" q="3" radius="0.18" radius-tubular="0.03" color="#fff" position="-0.35 0.12 0" visible="false"></a-torus-knot>
    </a-entity>
    <a-entity id="volk-10" mindar-image-target="targetIndex:10" position="0 0 0.04">
      <a-plane class="dbg" width="0.6" height="0.4" color="#00b894" material="opacity:0.75; transparent:true; side:double"></a-plane>
      <a-box class="hare" width="0.18" height="0.21" depth="0.12" color="#2ecc71" position="0.35 0.12 0.05"></a-box>
      <a-torus-knot class="moped" p="2" q="3" radius="0.18" radius-tubular="0.03" color="#fff" position="-0.35 0.12 0" visible="false"></a-torus-knot>
    </a-entity>

    <a-camera position="0 0 0" wasd-controls-enabled="false" look-controls-enabled="false"></a-camera>
  </a-scene>

  <script>
    (() => {
      const $  = s => document.querySelector(s);
      const $$ = s => Array.from(document.querySelectorAll(s));
      const scene = document.querySelector('a-scene');
      const getMIS = () => scene?.systems?.['mindar-image-system'];
      const gate = $('#gate'), hint = $('#hint'), ui = $('#ui');

      const showHint = t => { hint.textContent = t; hint.classList.remove('hidden'); };
      const hideHint  = () => hint.classList.add('hidden');
      const enableSnap= () => { $('#btn-snap').disabled = false; };
      const nukeOverlays = () => {
        $('#pre')?.classList.add('hidden');
        document.querySelectorAll('.pre,.preloader,.mindar-ui-overlay,.mindar-ui-loading,.mindar-ui-scanning').forEach(el => el.remove());
        document.body.style.background = 'transparent';
      };

      async function waitMindAR(timeout = 8000) {
        const t0 = performance.now();
        while (!getMIS()) { await new Promise(r => setTimeout(r, 50)); if (performance.now()-t0 > timeout) break; }
        return getMIS();
      }

      scene.addEventListener('loaded', () => console.log('[A-Frame] loaded'));
      scene.addEventListener('arReady', () => {
        const mis = getMIS();
        const v = mis?.video || mis?._video;
        if (v) {
          v.setAttribute('playsinline',''); v.muted = true;
          Object.assign(v.style, {position:'fixed', inset:'0', objectFit:'cover', zIndex:'0', display:'block'});
          try { v.play?.(); } catch {}
        }
        enableSnap(); nukeOverlays();
        console.log('[MindAR] arReady (video layered)');
      });
      document.querySelectorAll('[mindar-image-target]').forEach(target => {
        target.addEventListener('targetFound', () => {
          console.log('üéØ TARGET FOUND:', target.id);
          showHint('–¶–µ–ª—å –Ω–∞–π–¥–µ–Ω–∞: ' + target.id);
      });
      target.addEventListener('targetLost', () => {
        console.log('‚ùå TARGET LOST:', target.id);
        });
      });
      setTimeout(() => {
        const mis = getMIS();
        console.log('MindAR System:', mis);
        console.log('Targets count:', document.querySelectorAll('[mindar-image-target]').length);
      }, 2000);
      
      scene.addEventListener('arError', (e) => {
        nukeOverlays();
        console.error('[MindAR] arError', e?.detail || e);
        showHint('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–ø—É—Å—Ç–∏—Ç—å –∫–∞–º–µ—Ä—É. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –¥—Ä—É–≥–æ–π —Ä–µ–∂–∏–º –∏–ª–∏ –∑–∞–∫—Ä–æ–π—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è —Å –∫–∞–º–µ—Ä–æ–π.');
        if (!document.body.contains(gate)) document.body.appendChild(gate);
      });

      async function startAR(facingMode){
        hideHint(); $('#pre')?.classList.remove('hidden');
        const mis = await waitMindAR();
        if (!mis) { nukeOverlays(); showHint('AR-—è–¥—Ä–æ –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª–æ—Å—å. –û–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É.'); if (!document.body.contains(gate)) document.body.appendChild(gate); return; }
        try { await mis.stop?.(); } catch {}
        try {
          await mis.start?.({ facingMode });
          setTimeout(() => {
            const v = mis.video || mis._video;
            console.log('[MindAR video]', v?.videoWidth||0, v?.videoHeight||0, 'mode=', facingMode);
            nukeOverlays();
          }, 1500);
        } catch (err) {
          console.error('mis.start failed', err);
          nukeOverlays();
          showHint('–°—Ç–∞—Ä—Ç –∫–∞–º–µ—Ä—ã –Ω–µ —É–¥–∞–ª—Å—è. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –¥—Ä—É–≥–æ–π —Ä–µ–∂–∏–º –∏–ª–∏ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ.');
          if (!document.body.contains(gate)) document.body.appendChild(gate);
        }
        setTimeout(nukeOverlays, 4000);
      }

      $('#start-back').addEventListener('click', () => { gate.remove(); startAR('environment'); });
      $('#start-front').addEventListener('click', () => { gate.remove(); startAR('user'); });

      // ===== –ü–æ–≤–µ–¥–µ–Ω–∏–µ =====

      // –õ–∞—Ä–∏—Å–∫–∞
      $$('#shapo-0, #shapo-1, #shapo-2').forEach(anchor=>{
        const l = anchor.querySelector('.lariska');
        l?.addEventListener('click', ()=>{
          l.setAttribute('animation__wave','property: rotation; to: 0 45 0; dir: alternate; dur: 350; loop: 4; easing: easeInOutSine');
          setTimeout(()=> l.removeAttribute('animation__wave'), 1600);
        });
        bind(anchor, '–õ–∞—Ä–∏—Å–∫–∞ —Ä—è–¥–æ–º ‚Äî –Ω–∞–∂–º–∏, —á—Ç–æ–±—ã –ø–æ–º–∞—Ö–∞–ª–∞ üê≠');
      });

      // –ß–µ–±—É—Ä–∞—à–∫–∞ ‚Äî —É–≤–µ–ª–∏—á–µ–Ω–Ω—ã–µ ¬´–∞–ø–µ–ª—å—Å–∏–Ω—ã¬ª
      const rnd=(a,b)=>a+Math.random()*(b-a);
      $$('#cheb-3, #cheb-4').forEach(anchor=>{
        const rain = anchor.querySelector('.orange-rain'); let timer=null, count=0; const CAP=30;
        function spawn(){
          if(count>=CAP) return;
          const o=document.createElement('a-sphere');
          o.setAttribute('radius', rnd(0.08,0.14)); // –ë–û–õ–¨–®–ï –¥–ª—è –º–æ–±–∏–ª–∫–∏
          o.setAttribute('material','color: orange; metalness:0.1; roughness:0.9');
          const x=rnd(-0.45,0.45), y=rnd(0.7,1.3), z=rnd(-0.35,0.35);
          o.setAttribute('position', `${x} ${y} ${z}`);
          const dur=Math.floor(rnd(1400,2000));
          o.setAttribute('animation__fall', `property: position; to: ${x} -0.5 0; dur: ${dur}; easing: linear; loop: false`);
          o.addEventListener('animationcomplete__fall', ()=>{ o.remove(); count=Math.max(0,count-1); });
          rain.appendChild(o); count++;
        }
        bind(anchor, '–ß–µ–±—É—Ä–∞—à–∫–∞ ‚Äî –ª–æ–≤–∏—Ç–µ –∞–ø–µ–ª—å—Å–∏–Ω–∫–∏! üçä', {
          onFound(){ if(!timer) timer=setInterval(spawn,240); },
          onLost(){ if(timer){ clearInterval(timer); timer=null; } count=0; rain.innerHTML=''; }
        });
      });

      // –ì–µ–Ω–∞ ‚Äî –∑–∞–º–µ—Ç–Ω—ã–µ ¬´–Ω–æ—Ç—ã¬ª
      $$('#gena-5, #gena-6').forEach(anchor=>{
        const notes = anchor.querySelector('.notes'); let timer=null, cnt=0; const CAP=24, palette=['#2ecc71','#1abc9c','#3498db','#9b59b6','#f1c40f','#e84393'];
        function spawn(){
          if(cnt>=CAP) return;
          const n=document.createElement('a-circle');
          n.setAttribute('radius', rnd(0.05,0.09));  // –±–æ–ª—å—à–µ
          n.setAttribute('color', palette[Math.floor(Math.random()*palette.length)]);
          const x=rnd(-0.3,0.3), y=rnd(0.0,0.2), z=rnd(-0.2,0.2);
          n.setAttribute('material','side:double; opacity:0.95; transparent:true');
          n.setAttribute('position', `${x} ${y} ${z}`);
          const dur=Math.floor(rnd(900,1500));
          n.setAttribute('animation__rise', `property: position; to: ${x} ${y+rnd(0.8,1.2)} ${z}; dur: ${dur}; easing: easeOutSine`);
          n.addEventListener('animationcomplete__rise', ()=>{ n.remove(); cnt=Math.max(0,cnt-1); });
          notes.appendChild(n); cnt++;
        }
        bind(anchor, '–ì–µ–Ω–∞ –∏–≥—Ä–∞–µ—Ç ‚Äî –ª–µ—Ç—è—Ç –Ω–æ—Ç–∫–∏ üé∂', {
          onFound(){ if(!timer) timer=setInterval(spawn,200); },
          onLost(){ if(timer){ clearInterval(timer); timer=null; } cnt=0; notes.innerHTML=''; }
        });
      });

      // –í–æ–ª–∫ ‚Äî –±–æ–ª—å—à–µ —Ä–∞–∑–º–µ—Ä—ã, –æ–¥–∏–Ω –∫–ª–∏–∫ –ø–æ —Å—Ü–µ–Ω–µ –≤–∫–ª—é—á–∞–µ—Ç —É –∞–∫—Ç–∏–≤–Ω–æ–≥–æ
      const activeVolk = new Set();
      $$('#volk-7, #volk-8, #volk-9, #volk-10').forEach(anchor=>{
        const hare = anchor.querySelector('.hare');
        const moped = anchor.querySelector('.moped');
        anchor.addEventListener('targetFound', ()=> activeVolk.add(anchor.id));
        anchor.addEventListener('targetLost',  ()=> { activeVolk.delete(anchor.id); moped.setAttribute('visible', false); });
        hare?.addEventListener('click', ()=>{
          hare.setAttribute('animation__hop','property: position; to: 0.35 0.22 0.05; dir: alternate; dur: 280; loop: 2; easing:easeOutQuad');
          setTimeout(()=> hare.removeAttribute('animation__hop'), 750);
        });
        bind(anchor, '–í–æ–ª–∫ –∑–¥–µ—Å—å ‚Äî –∑–∞—è—Ü –¥—Ä–∞–∑–Ω–∏—Ç, –º–æ–ø–µ–¥ –ø–æ –∫–ª–∏–∫—É üõµ');
      });
      scene.addEventListener('click', (e)=>{
        if (ui.contains(e.target)) return;
        // –ø–µ—Ä–µ–∫–ª—é—á–∞–µ–º —Ç–æ–ª—å–∫–æ —É –±–ª–∏–∂–∞–π—à–µ–≥–æ –∞–∫—Ç–∏–≤–Ω–æ–≥–æ (—á—Ç–æ–±—ã –Ω–µ –º–∏–≥–∞–ª–∏ –≤—Å–µ)
        const id = activeVolk.values().next().value;
        if (!id) return;
        const moped = document.querySelector(`#${id} .moped`);
        if (!moped) return;
        const vis = moped.getAttribute('visible');
        moped.setAttribute('visible', !(vis===true || vis==='true'));
      });

      function bind(anchor, tip, {onFound,onLost} = {}){
        anchor.addEventListener('targetFound', ()=>{ showHint(tip); onFound && onFound(); console.log('[targetFound]', anchor.id); });
        anchor.addEventListener('targetLost',  ()=>{ hideHint(); onLost  && onLost();  console.log('[targetLost]',  anchor.id); });
      }
      $('#btn-snap').addEventListener('click', function() {
        console.log('üì∏ Snap button clicked');
        const canvas = document.querySelector('canvas');
        const video = document.querySelector('video');
        if (!canvas) {
          alert('Canvas –Ω–µ –Ω–∞–π–¥–µ–Ω');
          return;
        }
        console.log('Canvas size:', canvas.width, 'x', canvas.height);
        console.log('Video ready:', video ? video.videoWidth + 'x' + video.videoHeight : 'no video');
        try {
        // –ü—Ä–æ—Å—Ç–∞—è –≤–µ—Ä—Å–∏—è –±–µ–∑ share API
          const url = canvas.toDataURL('image/jpeg', 0.8);
          console.log('DataURL created, length:', url.length);
          —Åonst a = document.createElement('a');
          a.href = url;
          a.download = 'souzmult-ar-' + Date.now() + '.jpg';
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          showHint('üì∏ –°–Ω–∏–º–æ–∫ —Å–æ—Ö—Ä–∞–Ω–µ–Ω!');
        } catch (error) {
          console.error('Screenshot error:', error);
          alert('–û—à–∏–±–∫–∞: ' + error.message);
        }
      });

      // UI
      $('#btn-help').addEventListener('click', () => {
        alert('–°–æ–≤–µ—Ç—ã –¥–ª—è —Ç–µ–ª–µ—Ñ–æ–Ω–∞:\n‚Ä¢ –ù–∞–≤–µ–¥–∏—Ç–µ –∫–∞–º–µ—Ä—É –Ω–∞ —Å–∫—É–ª—å–ø—Ç—É—Ä—É –ø–æ–ª–Ω–æ—Å—Ç—å—é (–Ω–µ —Å–ª–∏—à–∫–æ–º –±–ª–∏–∑–∫–æ)\n‚Ä¢ –ü—Ä–∏ –ø–ª–æ—Ö–æ–º —Å–≤–µ—Ç–µ —Ç—Ä–µ–∫–∏–Ω–≥ ¬´–º–∏–≥–∞–µ—Ç¬ª ‚Äî –ø–æ–¥–æ–π–¥–∏—Ç–µ –±–ª–∏–∂–µ/—è—Ä—á–µ\n‚Ä¢ –ï—Å–ª–∏ –≤—Å—ë —Ä–∞–≤–Ω–æ –ø—É—Å—Ç–æ: –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ –≤–∫–ª–∞–¥–∫—É –∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Ñ—Ä–æ–Ω—Ç–∞–ª—å–Ω—É—é/–∑–∞–¥–Ω—é—é –∫–∞–º–µ—Ä—É');
      });
      
    })();
  </script>
</body>
</html>

