<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
  <title>–°–æ—é–∑–º—É–ª—å—Ç–ø–∞—Ä–∫ ‚Äî AR</title>
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 64 64%22><text y=%2250%25%22 x=%2250%25%22 dominant-baseline=%22middle%22 text-anchor=%22middle%22 font-size=%2248%22>üéüÔ∏è</text></svg>">

  <style>
    html,body{margin:0;padding:0;height:100%;overflow:hidden;background:transparent;font-family:system-ui,-apple-system,Arial}
    .ui{position:fixed;left:0;right:0;bottom:16px;display:flex;gap:10px;justify-content:center;z-index:10}
    .ui button{padding:10px 14px;border:none;border-radius:12px;background:rgba(0,0,0,.6);color:#fff;font-weight:600;backdrop-filter:blur(6px)}
    .overlay{position:fixed;top:12px;left:50%;transform:translateX(-50%);background:rgba(0,0,0,.55);color:#fff;padding:10px 14px;border-radius:12px;z-index:10;font-weight:700}
    .hidden{display:none !important}
    .pre{position:fixed;inset:0;display:grid;place-items:center;background:#000;color:#fff;z-index:20;font-weight:800}
    .gate{position:fixed;inset:0;display:grid;place-items:center;background:rgba(0,0,0,.86);color:#fff;z-index:25;text-align:center;padding:24px}
    .gate .row{display:flex;gap:12px;justify-content:center;margin-top:10px}
    .gate button{padding:12px 16px;border:none;border-radius:12px;background:#1a1a1a;color:#fff;font-weight:800}
    a-scene, a-scene canvas { position:fixed; inset:0; }
    a-scene canvas { z-index:1; background:transparent !important; }
    .mindar-ui-overlay,.mindar-ui-scanning,.mindar-ui-loading{display:none !important;opacity:0 !important;visibility:hidden !important}
  </style>

  <!-- A-Frame 1.2.0 -->
  <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
  <!-- MindAR 1.1.5: core -> aframe -->
  <script src="https://unpkg.com/mind-ar@1.1.5/dist/mindar-image.prod.js"></script>
  <script src="https://unpkg.com/mind-ar@1.1.5/dist/mindar-image-aframe.prod.js"></script>
</head>
<body>
  <div id="pre" class="pre">–ó–∞–≥—Ä—É–∂–∞–µ–º AR‚Ä¶</div>

  <div id="gate" class="gate">
    <div>
      <h2>–í–∫–ª—é—á–∏—Ç—å –∫–∞–º–µ—Ä—É</h2>
      <div class="row">
        <button id="start-back">–ó–∞–¥–Ω—è—è</button>
        <button id="start-front">–§—Ä–æ–Ω—Ç–∞–ª—å–Ω–∞—è</button>
      </div>
      <p style="opacity:.8;margin-top:10px">–ï—Å–ª–∏ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç ‚Äî –≤—ã–±–µ—Ä–∏ –¥—Ä—É–≥–æ–π —Ä–µ–∂–∏–º –∏ –∑–∞–∫—Ä–æ–π –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è/–≤–∫–ª–∞–¥–∫–∏ —Å –∫–∞–º–µ—Ä–æ–π.</p>
    </div>
  </div>

  <div id="hint" class="overlay hidden"></div>

  <div id="ui" class="ui">
    <button id="btn-help">?</button>
    <button id="btn-snap" disabled>üì∏ –°–Ω–∏–º–æ–∫</button>
    <button id="btn-ticket" onclick="location.href='ticket.html'">üéüÔ∏è –ë–∏–ª–µ—Ç—ã</button>
  </div>

  <a-scene
    renderer="alpha:true; physicallyCorrectLights:true; antialias:true"
    embedded
    vr-mode-ui="enabled:false"
    device-orientation-permission-ui="enabled:true"
    mindar-image="autoStart:false; imageTargetSrc: ./targets/targets.mind;
                  uiLoading:false; uiScanning:false;
                  warmupTolerance:5; missTolerance:5; maxTrack:4"
    loading-screen="enabled:false"
  >
    <a-entity light="type: ambient; intensity: 0.9"></a-entity>
    <a-entity light="type: directional; intensity: 0.8" position="0 1 0"></a-entity>

    <!-- —è–∫–æ—Ä—è —Å–æ–∑–¥–∞–¥–∏–º –ø—Ä–æ–≥—Ä–∞–º–º–Ω–æ -->
    <a-entity id="anchors-root"></a-entity>

    <a-camera position="0 0 0"></a-camera>
  </a-scene>

  <script>
  (() => {
    const $ = s => document.querySelector(s);
    const $$ = s => Array.from(document.querySelectorAll(s));
    const scene = document.querySelector('a-scene');
    const anchorsRoot = $('#anchors-root');
    const getMIS = () => scene?.systems?.['mindar-image-system'];
    const gate = $('#gate'), hint = $('#hint'), ui = $('#ui');

    const showHint = t => { hint.textContent = t; hint.classList.remove('hidden'); };
    const hideHint = () => hint.classList.add('hidden');
    const enableSnap = () => { $('#btn-snap').disabled = false; };
    const nukeOverlays = () => {
      $('#pre')?.classList.add('hidden');
      document.querySelectorAll('.pre,.preloader,.mindar-ui-overlay,.mindar-ui-loading,.mindar-ui-scanning').forEach(el => el.remove());
      document.body.style.background = 'transparent';
    };

    async function waitMindAR(timeout = 8000) {
      const t0 = performance.now();
      while (!getMIS()) { await new Promise(r => setTimeout(r, 50)); if (performance.now()-t0 > timeout) break; }
      return getMIS();
    }

    scene.addEventListener('loaded', () => console.log('[A-Frame] loaded'));
    scene.addEventListener('arReady', () => {
      const mis = getMIS();
      const v = mis?.video || mis?._video;
      if (v) {
        v.setAttribute('playsinline','');
        Object.assign(v.style, {position:'fixed', inset:'0', objectFit:'cover', zIndex:'0', display:'block'});
        try { v.play?.(); } catch {}
      }
      enableSnap(); nukeOverlays();
      console.log('[MindAR] arReady (video layered)');
    });
    scene.addEventListener('arError', (e) => {
      nukeOverlays();
      console.error('[MindAR] arError', e?.detail || e);
      showHint('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–ø—É—Å—Ç–∏—Ç—å –∫–∞–º–µ—Ä—É. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –¥—Ä—É–≥–æ–π —Ä–µ–∂–∏–º –∏–ª–∏ –∑–∞–∫—Ä–æ–π—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è —Å –∫–∞–º–µ—Ä–æ–π.');
      if (!document.body.contains(gate)) document.body.appendChild(gate);
    });

    async function startAR(facingMode){
      hideHint(); $('#pre')?.classList.remove('hidden');
      const mis = await waitMindAR();
      if (!mis) { nukeOverlays(); showHint('AR-—è–¥—Ä–æ –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª–æ—Å—å. –û–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É.'); if (!document.body.contains(gate)) document.body.appendChild(gate); return; }
      try { await mis.stop?.(); } catch {}
      try {
        await mis.start?.({ facingMode });
        setTimeout(() => {
          const v = mis.video || mis._video;
          console.log('[MindAR video]', v?.videoWidth||0, v?.videoHeight||0, 'mode=', facingMode);
          nukeOverlays();
        }, 1500);
      } catch (err) {
        console.error('mis.start failed', err);
        nukeOverlays();
        showHint('–°—Ç–∞—Ä—Ç –∫–∞–º–µ—Ä—ã –Ω–µ —É–¥–∞–ª—Å—è. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –¥—Ä—É–≥–æ–π —Ä–µ–∂–∏–º –∏–ª–∏ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ.');
        if (!document.body.contains(gate)) document.body.appendChild(gate);
      }
      setTimeout(nukeOverlays, 4000);
    }

    $('#start-back').addEventListener('click', () => { gate.remove(); startAR('environment'); });
    $('#start-front').addEventListener('click', () => { gate.remove(); startAR('user'); });

    // ---------- –ú–ê–ü–ü–ò–ù–ì –ò –ê–ù–ö–û–†–´ ----------
    // helper: –∫–∞–∫–æ–π —Ç–∏–ø –ø–æ –∏–Ω–¥–µ–∫—Å—É (–æ–¥–∏–Ω —è–∫–æ—Ä—å –Ω–∞ –∏–Ω–¥–µ–∫—Å, –±–µ–∑ –¥—É–±–ª–µ–π!)
    function typeForIndex(i){
      // –ø—Ä–µ–¥–ø–æ—á–∏—Ç–∞–µ–º 0-–±–∞–∑—É
      if ([0,1,2].includes(i)) return 'shapo';
      if ([3,4].includes(i))   return 'cheb';
      if ([5,6].includes(i))   return 'gena';
      if ([7,8,9,10].includes(i)) return 'volk';
      // fallback: 1-–±–∞–∑–∞
      if ([1,2,3].includes(i)) return 'shapo';
      if ([4,5].includes(i))   return 'cheb';
      if ([6,7].includes(i))   return 'gena';
      if ([8,9,10,11].includes(i)) return 'volk';
      return null;
    }

    // —Ö—Ä–∞–Ω–µ–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω—ã—Ö –≤–æ–ª–∫–æ–≤ -> –æ–¥–∏–Ω –∫–ª–∏–∫ –≤–∫–ª—é—á–∞–µ—Ç –º–æ–ø–µ–¥—ã —É –≤—Å–µ—Ö –∞–∫—Ç–∏–≤–Ω—ã—Ö
    const activeVolk = new Set();

    function bindTarget(el, {tip,onFound,onLost}) {
      if (!el) return;
      el.addEventListener('targetFound', () => { showHint(tip); onFound && onFound(); });
      el.addEventListener('targetLost',  () => { hideHint(); onLost  && onLost();  });
    }

    const rnd=(a,b)=>a+Math.random()*(b-a);

    function makeAnchor(i, type){
      const a = document.createElement('a-entity');
      a.setAttribute('id', `anchor-${type}-${i}`);
      a.setAttribute('mindar-image-target', `targetIndex: ${i}`);

      if (type === 'shapo'){
        const l = document.createElement('a-cone');
        l.setAttribute('radius-bottom','0.12'); l.setAttribute('height','0.25');
        l.setAttribute('color','#9c88ff'); l.setAttribute('position','0.1 0.25 0.05');
        a.appendChild(l);
        l.addEventListener('click', ()=>{
          l.setAttribute('animation__wave','property: rotation; to: 0 45 0; dir: alternate; dur: 350; loop: 4; easing: easeInOutSine');
          setTimeout(()=> l.removeAttribute('animation__wave'), 1600);
        });
        bindTarget(a,{tip:'–õ–∞—Ä–∏—Å–∫–∞ —Ä—è–¥–æ–º ‚Äî –Ω–∞–∂–º–∏, —á—Ç–æ–±—ã –ø–æ–º–∞—Ö–∞–ª–∞ üê≠'});
      }

      if (type === 'cheb'){
        const rain = document.createElement('a-entity');
        rain.setAttribute('id', `rain-${i}`); rain.setAttribute('position','0 1 0');
        a.appendChild(rain);
        let timer=null, count=0; const CAP=40;
        function spawn(){
          if(count>=CAP) return;
          const o=document.createElement('a-sphere');
          o.setAttribute('radius', rnd(0.04,0.08));
          o.setAttribute('material','color: orange; metalness:0.05; roughness:0.9');
          const x=rnd(-0.5,0.5), y=rnd(0.8,1.4), z=rnd(-0.4,0.4);
          o.setAttribute('position', `${x} ${y} ${z}`);
          const dur=Math.floor(rnd(1600,2600));
          o.setAttribute('animation__fall', `property: position; to: ${x} -0.5 0; dur: ${dur}; easing: linear; loop: false`);
          o.addEventListener('animationcomplete__fall', ()=>{ o.remove(); count=Math.max(0,count-1); });
          rain.appendChild(o); count++;
        }
        bindTarget(a,{
          tip:'–ß–µ–±—É—Ä–∞—à–∫–∞ ‚Äî –ª–æ–≤–∏—Ç–µ –∞–ø–µ–ª—å—Å–∏–Ω–∫–∏! üçä',
          onFound(){ if(!timer) timer=setInterval(spawn,260); },
          onLost(){ if(timer){ clearInterval(timer); timer=null; } count=0; rain.innerHTML=''; }
        });
      }

      if (type === 'gena'){
        const notes = document.createElement('a-entity');
        notes.setAttribute('id', `notes-${i}`);
        a.appendChild(notes);
        let timer=null, cnt=0; const CAP=32, palette=['#2ecc71','#1abc9c','#3498db','#9b59b6','#f1c40f'];
        function spawn(){
          if(cnt>=CAP) return;
          const n=document.createElement('a-sphere');
          n.setAttribute('radius', rnd(0.02,0.05));
          n.setAttribute('color', palette[Math.floor(Math.random()*palette.length)]);
          const x=rnd(-0.3,0.3), y=rnd(0.0,0.3), z=rnd(-0.2,0.2);
          n.setAttribute('position', `${x} ${y} ${z}`);
          const dur=Math.floor(rnd(1200,2000));
          n.setAttribute('opacity','0.0');
          n.setAttribute('animation__rise', `property: position; to: ${x} ${y+rnd(0.6,1.0)} ${z}; dur: ${dur}; easing: easeOutSine`);
          n.setAttribute('animation__fade', `property: opacity; from: 0; to: 1; dir: alternate; dur: ${Math.floor(dur/2)}; loop: 2`);
          n.addEventListener('animationcomplete__rise', ()=>{ n.remove(); cnt=Math.max(0,cnt-1); });
          notes.appendChild(n); cnt++;
        }
        bindTarget(a,{
          tip:'–ì–µ–Ω–∞ –∏–≥—Ä–∞–µ—Ç ‚Äî –ª–µ—Ç—è—Ç –Ω–æ—Ç–∫–∏ üé∂',
          onFound(){ if(!timer) timer=setInterval(spawn,220); },
          onLost(){ if(timer){ clearInterval(timer); timer=null; } cnt=0; notes.innerHTML=''; }
        });
      }

      if (type === 'volk'){
        const hare = document.createElement('a-box');
        hare.setAttribute('width','0.12'); hare.setAttribute('height','0.14'); hare.setAttribute('depth','0.08');
        hare.setAttribute('color','#2ecc71'); hare.setAttribute('position','0.35 0.08 0.05');
        const moped = document.createElement('a-torus-knot');
        moped.setAttribute('p','2'); moped.setAttribute('q','3');
        moped.setAttribute('radius','0.12'); moped.setAttribute('radius-tubular','0.02');
        moped.setAttribute('color','#e67e22'); moped.setAttribute('position','-0.35 0.08 0'); moped.setAttribute('visible','false');
        moped.setAttribute('id',`moped-${i}`);
        a.appendChild(hare); a.appendChild(moped);
        let active=false;
        a.addEventListener('targetFound', ()=> { active=true; activeVolk.add(i); });
        a.addEventListener('targetLost',  ()=> { active=false; activeVolk.delete(i); moped.setAttribute('visible', false); });
        hare.addEventListener('click', ()=>{
          hare.setAttribute('animation__hop','property: position; to: 0.35 0.16 0.05; dir: alternate; dur: 250; loop: 2; easing:easeOutQuad');
          setTimeout(()=> hare.removeAttribute('animation__hop'), 700);
        });
        bindTarget(a,{ tip:'–í–æ–ª–∫ –∑–¥–µ—Å—å ‚Äî –∑–∞—è—Ü –¥—Ä–∞–∑–Ω–∏—Ç, –º–æ–ø–µ–¥ –ø–æ –∫–ª–∏–∫—É üõµ' });
      }

      anchorsRoot.appendChild(a);
    }

    // —Å–æ–∑–¥–∞—ë–º —è–∫–æ—Ä—è –Ω–∞ 0..11 –ø–æ –ø—Ä–∞–≤–∏–ª–∞–º
    for (let i=0; i<=11; i++){
      const t = typeForIndex(i);
      if (t) makeAnchor(i, t);
    }

    // –æ–¥–∏–Ω –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –ø–æ —Å—Ü–µ–Ω–µ ‚Äî –≤–∫–ª—é—á–∞–µ—Ç/–≤—ã–∫–ª—é—á–∞–µ—Ç –º–æ–ø–µ–¥ —É –≤—Å–µ—Ö –∞–∫—Ç–∏–≤–Ω—ã—Ö –≤–æ–ª–∫–æ–≤
    scene.addEventListener('click', (e)=>{
      if (ui.contains(e.target)) return;
      activeVolk.forEach(i=>{
        const moped = document.getElementById(`moped-${i}`);
        if (!moped) return;
        const vis = moped.getAttribute('visible');
        moped.setAttribute('visible', !(vis===true || vis==='true'));
      });
    });

    // UI
    $('#btn-help').addEventListener('click', () => {
      alert('–ù–∞–≤–µ–¥–∏ –∫–∞–º–µ—Ä—É –Ω–∞ —Å–∫—É–ª—å–ø—Ç—É—Ä—É:\n‚Ä¢ –®–∞–ø–æ–∫–ª—è–∫ (–∏–Ω–¥–µ–∫—Å—ã 0‚Äì2 –∏–ª–∏ 1‚Äì3)\n‚Ä¢ –ß–µ–±—É—Ä–∞—à–∫–∞ (3‚Äì4 –∏–ª–∏ 4‚Äì5)\n‚Ä¢ –ì–µ–Ω–∞ (5‚Äì6 –∏–ª–∏ 6‚Äì7)\n‚Ä¢ –í–æ–ª–∫ (7‚Äì10 –∏–ª–∏ 8‚Äì11)');
    });
    $('#btn-snap').addEventListener('click', async () => {
      const c = document.querySelector('canvas'); if (!c) return alert('–ö–∞–º–µ—Ä–∞ –µ—â—ë –Ω–µ –≥–æ—Ç–æ–≤–∞');
      const url = c.toDataURL('image/jpeg', 0.95);
      try {
        const blob = await (await fetch(url)).blob();
        const file = new File([blob], 'souzmult-ar.jpg', {type:'image/jpeg'});
        if (navigator.canShare?.({files:[file]})) { await navigator.share({files:[file], title:'AR —Ñ–æ—Ç–æ'}); return; }
      } catch {}
      const a=document.createElement('a'); a.href=url; a.download='souzmult-ar.jpg'; a.click();
    });

  })();
  </script>
</body>
</html>
