<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
  <title>–°–æ—é–∑–º—É–ª—å—Ç–ø–∞—Ä–∫ ‚Äî AR</title>
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 64 64%22><text y=%2250%25%22 x=%2250%25%22 dominant-baseline=%22middle%22 text-anchor=%22middle%22 font-size=%2248%22>üéüÔ∏è</text></svg>">

  <style>
    html,body{margin:0;padding:0;height:100%;overflow:hidden;background:#000;font-family:system-ui,-apple-system,Arial}
    .ui{position:fixed;left:0;right:0;bottom:16px;display:flex;gap:10px;justify-content:center;z-index:10}
    .ui button{padding:10px 14px;border:none;border-radius:12px;background:rgba(0,0,0,.6);color:#fff;font-weight:600;backdrop-filter:blur(6px)}
    .overlay{position:fixed;top:12px;left:50%;transform:translateX(-50%);background:rgba(0,0,0,.55);color:#fff;padding:10px 14px;border-radius:12px;z-index:10;font-weight:700}
    .hidden{display:none}
    .pre{position:fixed;inset:0;display:grid;place-items:center;background:#000;color:#fff;z-index:20;font-weight:800}
    .gate{position:fixed;inset:0;display:grid;place-items:center;background:rgba(0,0,0,.86);color:#fff;z-index:25;text-align:center;padding:24px}
    .gate .row{display:flex;gap:12px;justify-content:center;margin-top:10px}
    .gate button{padding:12px 16px;border:none;border-radius:12px;background:#1a1a1a;color:#fff;font-weight:800}
  </style>

  <!-- A-Frame 1.2.0 (—Å—Ç–∞–±–∏–ª—å–Ω–æ —Å MindAR 1.1.5) -->
  <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>

  <!-- MindAR 1.1.5. –ü–û–†–Ø–î–û–ö –í–ê–ñ–ï–ù: core -> aframe-–æ–±—ë—Ä—Ç–∫–∞ -->
  <script src="https://unpkg.com/mind-ar@1.1.5/dist/mindar-image.prod.js"></script>
  <script src="https://unpkg.com/mind-ar@1.1.5/dist/mindar-image-aframe.prod.js"></script>
</head>
<body>
  <!-- –†—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫ -->
  <div id="gate" class="gate">
    <div>
      <h2>–í–∫–ª—é—á–∏—Ç—å –∫–∞–º–µ—Ä—É</h2>
      <div class="row">
        <button id="start-back">–ó–∞–¥–Ω—è—è</button>
        <button id="start-front">–§—Ä–æ–Ω—Ç–∞–ª—å–Ω–∞—è</button>
      </div>
      <p style="opacity:.8;margin-top:10px">–ï—Å–ª–∏ —á—ë—Ä–Ω—ã–π —ç–∫—Ä–∞–Ω ‚Äî –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –¥—Ä—É–≥–æ–π —Ä–µ–∂–∏–º –∏–ª–∏ –∑–∞–∫—Ä–æ–π—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è/–≤–∫–ª–∞–¥–∫–∏, –∫–æ—Ç–æ—Ä—ã–µ –∏—Å–ø–æ–ª—å–∑—É—é—Ç –∫–∞–º–µ—Ä—É.</p>
    </div>
  </div>

  <div id="pre" class="pre hidden">–ó–∞–≥—Ä—É–∂–∞–µ–º AR‚Ä¶</div>
  <div id="hint" class="overlay hidden"></div>

  <div id="ui" class="ui">
    <button id="btn-help">?</button>
    <button id="btn-snap" disabled>üì∏ –°–Ω–∏–º–æ–∫</button>
    <button id="btn-ticket" onclick="location.href='ticket.html'">üéüÔ∏è –ë–∏–ª–µ—Ç—ã</button>
  </div>

  <!-- –°—Ü–µ–Ω–∞: –æ–¥–∏–Ω targets.mind, –∞–≤—Ç–æ—Å—Ç–∞—Ä—Ç –≤—ã–∫–ª -->
  <a-scene
    renderer="alpha:true; physicallyCorrectLights:true; antialias:true"
    embedded
    vr-mode-ui="enabled:false"
    device-orientation-permission-ui="enabled:true"
    mindar-image="autoStart: false; imageTargetSrc: ./targets/targets.mind; warmupTolerance:5"
    loading-screen="enabled:false"
  >
    <a-entity light="type: ambient; intensity: 0.9"></a-entity>
    <a-entity light="type: directional; intensity: 0.8" position="0 1 0"></a-entity>

    <a-entity id="tgt-cheb" mindar-image-target="targetIndex: 0">
      <a-entity id="orange-rain" position="0 1 0"></a-entity>
    </a-entity>

    <a-entity id="tgt-shapo" mindar-image-target="targetIndex: 1">
      <a-cone id="lariska-model" radius-bottom="0.12" height="0.25" color="#9c88ff" position="0.1 0.25 0.05"></a-cone>
    </a-entity>

    <a-entity id="tgt-volk" mindar-image-target="targetIndex: 2">
      <a-box id="hare-model" width="0.12" height="0.14" depth="0.08" color="#2ecc71" position="0.35 0.08 0.05"></a-box>
      <a-torus-knot id="moped-model" p="2" q="3" radius="0.12" radius-tubular="0.02" color="#e67e22" position="-0.35 0.08 0" visible="false"></a-torus-knot>
    </a-entity>

    <a-camera position="0 0 0"></a-camera>
  </a-scene>

  <script>
    (() => {
      const $ = s => document.querySelector(s);
      const scene = document.querySelector('a-scene');
      const mis = () => scene.systems['mindar-image-system'];
      const pre = $('#pre'), gate = $('#gate'), hint = $('#hint'), ui = $('#ui');

      const showHint = t => { hint.textContent = t; hint.classList.remove('hidden'); };
      const hideHint = () => hint.classList.add('hidden');
      const enableSnap = () => { $('#btn-snap').disabled = false; };

      scene.addEventListener('loaded', () => console.log('[A-Frame] loaded'));
      scene.addEventListener('arReady', () => { pre.classList.add('hidden'); enableSnap(); console.log('[MindAR] arReady'); });
      scene.addEventListener('arError', (e) => {
        pre.classList.add('hidden');
        console.error('[MindAR] arError', e?.detail || e);
        showHint('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–ø—É—Å—Ç–∏—Ç—å –∫–∞–º–µ—Ä—É. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –¥—Ä—É–≥–æ–π —Ä–µ–∂–∏–º –∏–ª–∏ –∑–∞–∫—Ä–æ–π—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è —Å –∫–∞–º–µ—Ä–æ–π.');
        if (!document.body.contains(gate)) document.body.appendChild(gate);
      });
      scene.addEventListener('camera-init', () => console.log('[Camera] camera-init'));
      scene.addEventListener('camera-error', (e) => console.error('[Camera] camera-error', e?.detail || e));

      async function startAR(facingMode){
        hideHint();
        pre.classList.remove('hidden');
        try { await mis().stop?.(); } catch {}
        try {
          // MindAR 1.1.5 –ø—Ä–∏–Ω–∏–º–∞–µ—Ç facingMode –≤ –æ–ø—Ü–∏—è—Ö
          await mis().start({ facingMode });

          // –ß–µ—Ä–µ–∑ 2.5—Å –ø—Ä–æ–≤–µ—Ä—è–µ–º: –≤–∏–¥–µ–æ —Ä–µ–∞–ª—å–Ω–æ –ø—Ä–∏–≤—è–∑–∞–ª–æ—Å—å?
          setTimeout(() => {
            const v = mis().video || mis()._video;
            const w = v?.videoWidth||0, h = v?.videoHeight||0;
            console.log('[MindAR video]', w, h, 'mode=', facingMode);
            if (w === 0 || h === 0) {
              console.warn('Video is 0x0 ‚Äî retry with alterna
