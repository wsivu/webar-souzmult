<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
  <title>–°–æ—é–∑–º—É–ª—å—Ç–ø–∞—Ä–∫ ‚Äî AR</title>

  <!-- –ò–∫–æ–Ω–∫–∞ -->
  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 64 64%22><text y=%2250%25%22 x=%2250%25%22 dominant-baseline=%22middle%22 text-anchor=%22middle%22 font-size=%2248%22>üéüÔ∏è</text></svg>">

  <!-- –ë–∞–∑–æ–≤—ã–µ —Å—Ç–∏–ª–∏ -->
  <style>
    html, body { margin:0; padding:0; height:100%; overflow:hidden; font-family: system-ui, -apple-system, Arial; background:#000; }
    .ui { position: fixed; bottom: 16px; left: 0; right: 0; display: flex; gap: 10px; justify-content: center; z-index: 10; }
    .ui button { padding: 10px 14px; border-radius: 12px; border: none; background: rgba(0,0,0,.6); color: #fff; font-weight: 600; backdrop-filter: blur(6px); box-shadow: 0 4px 24px rgba(0,0,0,.4); }
    .ui button:active { transform: scale(0.98); }

    .overlay { position: fixed; top: 12px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,.55); color:#fff; padding:10px 14px; border-radius:12px; z-index:10; font-weight:700; }
    .overlay.hidden { display:none; }

    .rotate { position: fixed; inset: 0; display: grid; place-items: center; background: rgba(0,0,0,.7); color:#fff; z-index: 11; font-weight: 800; text-align:center; padding: 24px; }
    .rotate.hidden { display:none; }

    .gate { position: fixed; inset: 0; display: grid; place-items: center; background: rgba(0,0,0,.8); color:#fff; z-index: 12; text-align:center; padding:24px; }
    .gate.hidden { display:none; }
    .gate button { padding: 12px 16px; border-radius: 12px; border: none; background: #1a1a1a; color: #fff; font-weight: 800; }

    .preloader{ position:fixed; inset:0; display:grid; place-items:center; background:#000; opacity:.9; color:#fff; z-index:20; font-weight:800; }
    .preloader.hidden{ display:none; }
  </style>

  <!-- A-Frame -->
  <script src="https://unpkg.com/aframe@1.6.0/dist/aframe.min.js"></script>
  <!-- MindAR (CDN, —Å—Ç–∞–±–∏–ª—å–Ω–∞—è 1.1.5 –±–µ–∑ module workers) -->
  <script src="https://unpkg.com/mind-ar@1.1.5/dist/mindar-image-aframe.prod.js"></script>
</head>
<body>
  <!-- –ü—Ä–µ–ª–æ–∞–¥–µ—Ä -->
  <div id="preloader" class="preloader">–ó–∞–≥—Ä—É–∂–∞–µ–º AR‚Ä¶</div>

  <!-- –ü–æ–¥—Å–∫–∞–∑–∫–∏ -->
  <div id="hint" class="overlay hidden"></div>

  <!-- UI -->
  <div id="ui" class="ui">
    <button id="btn-help" aria-label="–ü–æ–º–æ—â—å">?</button>
    <button id="btn-snap" aria-label="–°–Ω–∏–º–æ–∫" disabled>üì∏ –°–Ω–∏–º–æ–∫</button>
    <button id="btn-selfie" aria-label="–°–µ–ª—Ñ–∏">ü§≥ –°–µ–ª—Ñ–∏</button>
    <button id="btn-ticket" aria-label="–ë–∏–ª–µ—Ç—ã" onclick="location.href='ticket.html'">üéüÔ∏è –ë–∏–ª–µ—Ç—ã</button>
  </div>

  <!-- –û–≤–µ—Ä–ª–µ–∏ -->
  <div id="rotate" class="rotate hidden">–ü–æ–≤–µ—Ä–Ω–∏—Ç–µ —Ç–µ–ª–µ—Ñ–æ–Ω –≤ –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã–π —Ä–µ–∂–∏–º</div>
  <div id="ios-gate" class="gate hidden">
    <p>–ù–∞–∂–º–∏—Ç–µ, —á—Ç–æ–±—ã –≤–∫–ª—é—á–∏—Ç—å –∫–∞–º–µ—Ä—É</p>
    <button id="ios-allow">–í–∫–ª—é—á–∏—Ç—å</button>
  </div>

  <!-- –°—Ü–µ–Ω–∞: –û–î–ò–ù targets.mind —Å —Ç—Ä–µ–º—è —Ü–µ–ª—è–º–∏ -->
  <a-scene
    renderer="alpha:true; colorManagement:true; physicallyCorrectLights:true; antialias:true"
    embedded
    vr-mode-ui="enabled:false"
    device-orientation-permission-ui="enabled:true"
    mindar-image="imageTargetSrc: ./targets/targets.mind; filterMinCF:0.0002; filterBeta:0.001; warmupTolerance:5"
    loading-screen="enabled:false"
  >
    <!-- –°–≤–µ—Ç -->
    <a-entity light="type: ambient; intensity: 0.9"></a-entity>
    <a-entity light="type: directional; intensity: 0.8" position="0 1 0"></a-entity>

    <!-- –ß–µ–±—É—Ä–∞—à–∫–∞ -->
    <a-entity id="tgt-cheb" mindar-image-target="targetIndex: 0">
      <a-entity id="orange-rain" position="0 1 0"></a-entity>
    </a-entity>

    <!-- –®–∞–ø–æ–∫–ª—è–∫/–ì–µ–Ω–∞ -->
    <a-entity id="tgt-shapo" mindar-image-target="targetIndex: 1">
      <a-cone id="lariska-model" radius-bottom="0.12" height="0.25" color="#9c88ff" position="0.1 0.25 0.05"></a-cone>
    </a-entity>

    <!-- –í–æ–ª–∫ -->
    <a-entity id="tgt-volk" mindar-image-target="targetIndex: 2">
      <a-box id="hare-model" depth="0.08" height="0.14" width="0.12" color="#2ecc71" position="0.35 0.08 0.05"></a-box>
      <a-torus-knot id="moped-model" p="2" q="3" radius="0.12" radius-tubular="0.02" color="#e67e22" position="-0.35 0.08 0" visible="false"></a-torus-knot>
    </a-entity>

    <a-camera position="0 0 0"></a-camera>
  </a-scene>

  <!-- –õ–û–ì–ò–ö–ê (–∏–Ω–ª–∞–π–Ω, —á—Ç–æ–±—ã –∏—Å–∫–ª—é—á–∏—Ç—å 404 js-—Ñ–∞–π–ª–æ–≤) -->
  <script>
    (() => {
      const $ = (sel, root=document) => root.querySelector(sel);
      const rnd = (a,b)=> a + Math.random()*(b-a);
      const buzz = ms => 'vibrate' in navigator && navigator.vibrate(ms);

      const hint = $('#hint');
      const pre  = $('#preloader');
      const ui   = $('#ui');

      const showHint = (text) => { if(hint){ hint.textContent = text; hint.classList.remove('hidden'); } };
      const hideHint = () => hint && hint.classList.add('hidden');

      const snapBtn = document.getElementById('btn-snap');
      const enableSnap = () => { if (snapBtn) snapBtn.disabled = false; };

      // iOS –≥–µ–π—Ç (—á–∏—Å—Ç–æ –≤–∏–∑—É–∞–ª—å–Ω—ã–π ‚Äî —Å–∫—Ä—ã–≤–∞–µ–º –ø–æ —Ç–∞–ø—É)
      const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
      const isSafari = /^((?!chrome|android).)*safari/i.test(navigator.userAgent);
      const gate = $('#ios-gate');
      if (isIOS && isSafari && gate) gate.classList.remove('hidden');
      $('#ios-allow')?.addEventListener('click', ()=> gate.classList.add('hidden'));

      // –û—Ä–∏–µ–Ω—Ç–∞—Ü–∏—è
      const rotate = $('#rotate');
      const onResize = () => {
        if (!rotate) return;
        const portrait = window.matchMedia('(orientation: portrait)').matches;
        rotate.classList.toggle('hidden', portrait);
      };
      window.addEventListener('resize', onResize); onResize();

      // –ü–æ–¥—Å–∫–∞–∑–∫–∞ –ø–æ ?s=
      const s = new URLSearchParams(location.search).get('s');
      if (s === 'cheb') showHint('–ü–æ–¥–æ–π–¥–∏—Ç–µ –∫ —Å–∫—É–ª—å–ø—Ç—É—Ä–µ –ß–µ–±—É—Ä–∞—à–∫–∏ –∏ –Ω–∞–≤–µ–¥–∏—Ç–µ –∫–∞–º–µ—Ä—É');
      if (s === 'shapo') showHint('–ù–∞–≤–µ–¥–∏—Ç–µ –Ω–∞ –®–∞–ø–æ–∫–ª—è–∫/–ì–µ–Ω—É ‚Äî –ø–æ—è–≤–∏—Ç—Å—è –õ–∞—Ä–∏—Å–∫–∞');
      if (s === 'volk') showHint('–ù–∞–π–¥–∏—Ç–µ –í–æ–ª–∫–∞ –Ω–∞ —Å–∫–∞–º–µ–π–∫–µ ‚Äî —Ä—è–¥–æ–º –ø–æ—è–≤–∏—Ç—Å—è –ó–∞—è—Ü');

      // –°—Ü–µ–Ω–∞ –∏ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ MindAR/A-Frame
      const scene = document.querySelector('a-scene');
      if (scene) {
        scene.addEventListener('loaded', () => { pre && pre.classList.add('hidden'); console.log('[A-Frame] loaded'); });
        scene.addEventListener('arReady', () => { pre && pre.classList.add('hidden'); enableSnap(); console.log('[MindAR] arReady'); });
        scene.addEventListener('arError', (e) => {
          pre && pre.classList.add('hidden');
          console.error('[MindAR] arError', e?.detail || e);
          showHint('AR –Ω–µ —Å—Ç–∞—Ä—Ç–æ–≤–∞–ª. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ HTTPS, —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ –∫–∞–º–µ—Ä—ã –∏ –Ω–∞–ª–∏—á–∏–µ ./targets/targets.mind');
        });
        scene.addEventListener('camera-init', () => console.log('[Camera] camera-init'));
        scene.addEventListener('camera-error', (e) => console.error('[Camera] camera-error', e?.detail || e));
      }

      // Fallback: –µ—Å–ª–∏ –Ω–∏—á–µ–≥–æ –Ω–µ –ø—Ä–æ–∏–∑–æ—à–ª–æ ‚Äî —É–±–∏—Ä–∞–µ–º –ø—Ä–µ–ª–æ–∞–¥–µ—Ä —á–µ—Ä–µ–∑ 6—Å –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–¥—Å–∫–∞–∑–∫—É
      setTimeout(() => {
        if (!pre.classList.contains('hidden')) {
          pre.classList.add('hidden');
          showHint('–ï—Å–ª–∏ –∫–∞–º–µ—Ä–∞ –Ω–µ –≤–∫–ª—é—á–∏–ª–∞—Å—å: –¥–∞–π—Ç–µ –¥–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ –∏ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É');
        }
      }, 6000);

      // –ê–∫—Ç–∏–≤–Ω—ã–µ —Ü–µ–ª–∏
      const active = new Set();
      const bindTarget = (el, {onFound, onLost, name, tip}) => {
        if(!el) return;
        el.addEventListener('targetFound', () => {
          active.add(el.id);
          showHint(tip || name);
          buzz(10);
          onFound && onFound();
        });
        el.addEventListener('targetLost', () => {
          active.delete(el.id);
          hideHint();
          onLost && onLost();
        });
      };

      // –ß–ï–ë–£–†–ê–®–ö–ê ‚Äî –¥–æ–∂–¥—å –∞–ø–µ–ª—å—Å–∏–Ω–æ–≤
      const orangeContainer = $('#orange-rain');
      let rainTimer = null, orangeCount = 0;
      const ORANGE_CAP = 40;

      function spawnOrange(){
        if (!orangeContainer) return;
        if (orangeCount >= ORANGE_CAP) return;

        const o = document.createElement('a-sphere');
        o.setAttribute('radius', rnd(0.04, 0.08));
        o.setAttribute('material', 'color: orange; metalness:0.05; roughness:0.9');

        const x = rnd(-0.5, 0.5);
        const y = rnd(0.8, 1.4);
        const z = rnd(-0.4, 0.4);
        o.setAttribute('position', `${x} ${y} ${z}`);

        const dur = Math.floor(rnd(1600, 2600));
        o.setAttribute('animation__fall', `property: position; to: ${x} -0.5 0; dur: ${dur}; easing: linear; loop: false`);

        o.addEventListener('animationcomplete__fall', () => {
          o.remove();
          orangeCount = Math.max(0, orangeCount - 1);
        });

        orangeContainer.appendChild(o);
        orangeCount++;
      }

      bindTarget($('#tgt-cheb'), {
        name: '–ß–µ–±—É—Ä–∞—à–∫–∞', tip: '–ß–µ–±—É—Ä–∞—à–∫–∞ ‚Äî –ª–æ–≤–∏—Ç–µ –∞–ø–µ–ª—å—Å–∏–Ω–∫–∏! üçä',
        onFound() { if (!rainTimer) rainTimer = setInterval(spawnOrange, 260); },
        onLost()  { if (rainTimer) { clearInterval(rainTimer); rainTimer = null; } orangeCount = 0; orangeContainer && (orangeContainer.innerHTML = ''); }
      });

      // –®–∞–ø–æ–∫–ª—è–∫ ‚Äî ¬´–õ–∞—Ä–∏—Å–∫–∞ –º–∞—à–µ—Ç¬ª
      const lariska = $('#lariska-model');
      if (lariska) {
        lariska.addEventListener('click', () => {
          lariska.setAttribute('animation__wave','property: rotation; to: 0 45 0; dir: alternate; dur: 350; loop: 4; easing: easeInOutSine');
          setTimeout(() => lariska.removeAttribute('animation__wave'), 1600);
        });
      }
      bindTarget($('#tgt-shapo'), {
        name:'–®–∞–ø–æ–∫–ª—è–∫', tip:'–õ–∞—Ä–∏—Å–∫–∞ —Ä—è–¥–æ–º ‚Äî –Ω–∞–∂–º–∏, —á—Ç–æ–±—ã –ø–æ–º–∞—Ö–∞–ª–∞ üê≠',
        onFound(){}, onLost(){}
      });

      // –í–æ–ª–∫ ‚Äî –∑–∞—è—Ü + –º–æ–ø–µ–¥
      const moped = $('#moped-model');
      const hare  = $('#hare-model');
      if (hare) {
        hare.addEventListener('click', () => {
          hare.setAttribute('animation__hop','property: position; to: 0.35 0.16 0.05; dir: alternate; dur: 250; loop: 2; easing:easeOutQuad');
          setTimeout(() => hare.removeAttribute('animation__hop'), 700);
        });
      }
      const sceneEl = document.querySelector('a-scenes');
      (document.querySelector('a-scene')||document).addEventListener('click', (e) => {
        if (ui && ui.contains(e.target)) return;
        if (!moped) return;
        if (!active.has('tgt-volk')) return;
        const vis = moped.getAttribute('visible');
        moped.setAttribute('visible', !(vis === true || vis === 'true'));
      });

      // –°–µ–ª—Ñ–∏
      document.getElementById('btn-selfie')?.addEventListener('click', ()=> location.href = 'face.html');

      // –°–Ω–∏–º–æ–∫
      document.getElementById('btn-snap')?.addEventListener('click', async () => {
        const canvas = document.querySelector('canvas');
        if (!canvas) return alert('–ö–∞–º–µ—Ä–∞ –Ω–µ –≥–æ—Ç–æ–≤–∞: –æ—Ç–∫—Ä–æ–π—Ç–µ —Å–∞–π—Ç –ø–æ HTTPS –∏ —Ä–∞–∑—Ä–µ—à–∏—Ç–µ –¥–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ.');
        const dataURL = canvas.toDataURL('image/jpeg', 0.95);
        try {
          const blob = await (await fetch(dataURL)).blob();
          const file = new File([blob], 'souzmult-ar.jpg', { type: 'image/jpeg' });
          if (navigator.canShare?.({ files: [file] })) {
            await navigator.share({ files: [file], title: 'AR —Ñ–æ—Ç–æ' });
            return;
          }
        } catch {}
        const a = document.createElement('a'); a.href = dataURL; a.download = 'souzmult-ar.jpg'; a.click();
      });

      // –ö–Ω–æ–ø–∫–∞ ¬´?¬ª
      document.getElementById('btn-help')?.addEventListener('click', () => {
        alert(
`–ù–∞–≤–µ–¥–∏—Ç–µ –∫–∞–º–µ—Ä—É –Ω–∞ —Ñ–æ—Ç–æ —Å–∫—É–ª—å–ø—Ç—É—Ä—ã (–ß–µ–±—É—Ä–∞—à–∫–∞ / –®–∞–ø–æ–∫–ª—è–∫‚Äì–ì–µ–Ω–∞ / –í–æ–ª–∫).

–ß–µ–±—É—Ä–∞—à–∫–∞: –¥–æ–∂–¥—å –∞–ø–µ–ª—å—Å–∏–Ω–æ–≤.
–®–∞–ø–æ–∫–ª—è–∫: –õ–∞—Ä–∏—Å–∫–∞ –º–∞—à–µ—Ç.
–í–æ–ª–∫: –ó–∞—è—Ü –¥—Ä–∞–∑–Ω–∏—Ç, –º–æ–ø–µ–¥ –≤–∫–ª—é—á–∞–µ—Ç—Å—è –ø–æ –Ω–∞–∂–∞—Ç–∏—é.

üì∏ ‚Äî —Å–Ω–∏–º–æ–∫, ü§≥ ‚Äî —Å–µ–ª—Ñ–∏.`);
      });
    })();
  </script>
</body>
</html>
