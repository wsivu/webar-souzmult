<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
  <title>–°–æ—é–∑–º—É–ª—å—Ç–ø–∞—Ä–∫ ‚Äî AR</title>

  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 64 64%22><text y=%2250%25%22 x=%2250%25%22 dominant-baseline=%22middle%22 text-anchor=%22middle%22 font-size=%2248%22>üéüÔ∏è</text></svg>">

  <style>
    html, body { margin:0; padding:0; height:100%; overflow:hidden; font-family: system-ui, -apple-system, Arial; background:#000; }
    .ui { position: fixed; bottom: 16px; left: 0; right: 0; display: flex; gap: 10px; justify-content: center; z-index: 10; }
    .ui button { padding: 10px 14px; border-radius: 12px; border: none; background: rgba(0,0,0,.6); color: #fff; font-weight: 600; backdrop-filter: blur(6px); box-shadow: 0 4px 24px rgba(0,0,0,.4); }
    .overlay { position: fixed; top: 12px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,.55); color:#fff; padding:10px 14px; border-radius:12px; z-index:10; font-weight:700; }
    .overlay.hidden { display:none; }
    .preloader{ position:fixed; inset:0; display:grid; place-items:center; background:#000; opacity:.9; color:#fff; z-index:20; font-weight:800; }
    .preloader.hidden{ display:none; }

    .gate { position: fixed; inset: 0; display: grid; place-items: center; background: rgba(0,0,0,.86); color:#fff; z-index: 25; text-align:center; padding:24px; }
    .gate h2 { margin:0 0 12px; }
    .gate .row { display:flex; gap:12px; justify-content:center; margin-top:10px; }
    .gate button { padding: 12px 16px; border-radius: 12px; border: none; background: #1a1a1a; color: #fff; font-weight: 800; }
    .gate small { display:block; opacity:.8; margin-top:10px; }

    /* –æ—Ç–ª–∞–¥–æ—á–Ω—ã–π —Å—ã—Ä–æ–π –≤–∏–¥–µ–æ-–ø–æ—Ç–æ–∫ (–≤–∫–ª—é—á–∞–µ–º –ø–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏) */
    #rawvideo { position:fixed; inset:0; object-fit:cover; z-index:5; display:none; }
  </style>

  <!-- A-Frame 1.4.2 (—Å–æ–≤–º–µ—Å—Ç–∏–º–æ —Å MindAR 1.1.5) -->
  <script src="https://unpkg.com/aframe@1.4.2/dist/aframe.min.js"></script>

  <!-- MindAR 1.1.5: –ü–û–†–Ø–î–û–ö –í–ê–ñ–ï–ù -->
  <script src="https://unpkg.com/mind-ar@1.1.5/dist/mindar-image.prod.js"></script>
  <script src="https://unpkg.com/mind-ar@1.1.5/dist/mindar-image-aframe.prod.js"></script>
</head>
<body>
  <!-- —Å—Ç–∞—Ä—Ç-–æ–≤–µ—Ä–ª–µ–π: —Ä—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫ —Å –≤—ã–±–æ—Ä–æ–º –∫–∞–º–µ—Ä—ã -->
  <div id="start-gate" class="gate">
    <div>
      <h2>–í–∫–ª—é—á–∏—Ç—å –∫–∞–º–µ—Ä—É</h2>
      <div class="row">
        <button id="btn-start-back">–ó–∞–¥–Ω—è—è</button>
        <button id="btn-start-front">–§—Ä–æ–Ω—Ç–∞–ª—å–Ω–∞—è</button>
      </div>
      <small>–ï—Å–ª–∏ –±—Ä–∞—É–∑–µ—Ä —Å–ø—Ä–æ—Å–∏—Ç ‚Äî —Ä–∞–∑—Ä–µ—à–∏—Ç–µ –¥–æ—Å—Ç—É–ø. –ï—Å–ª–∏ –≤–∏–¥–∏—Ç–µ —á—ë—Ä–Ω—ã–π —ç–∫—Ä–∞–Ω ‚Äî –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –¥—Ä—É–≥–æ–π —Ä–µ–∂–∏–º –∏–ª–∏ –∑–∞–∫—Ä–æ–π—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è, –∫–æ—Ç–æ—Ä—ã–µ –∏—Å–ø–æ–ª—å–∑—É—é—Ç –∫–∞–º–µ—Ä—É.</small>
    </div>
  </div>

  <video id="rawvideo" playsinline muted></video>
  <div id="preloader" class="preloader hidden">–ó–∞–≥—Ä—É–∂–∞–µ–º AR‚Ä¶</div>
  <div id="hint" class="overlay hidden"></div>

  <div id="ui" class="ui">
    <button id="btn-help" aria-label="–ü–æ–º–æ—â—å">?</button>
    <button id="btn-snap" aria-label="–°–Ω–∏–º–æ–∫" disabled>üì∏ –°–Ω–∏–º–æ–∫</button>
    <button id="btn-ticket" aria-label="–ë–∏–ª–µ—Ç—ã" onclick="location.href='ticket.html'">üéüÔ∏è –ë–∏–ª–µ—Ç—ã</button>
  </div>

  <!-- –æ–¥–∏–Ω targets.mind, –∞–≤—Ç–æ—Å—Ç–∞—Ä—Ç –≤—ã–∫–ª -->
  <a-scene
    renderer="alpha:true; colorManagement:true; physicallyCorrectLights:true; antialias:true"
    embedded
    vr-mode-ui="enabled:false"
    device-orientation-permission-ui="enabled:true"
    mindar-image="autoStart: false; imageTargetSrc: ./targets/targets.mind; filterMinCF:0.0002; filterBeta:0.001; warmupTolerance:5"
    loading-screen="enabled:false"
  >
    <a-entity light="type: ambient; intensity: 0.9"></a-entity>
    <a-entity light="type: directional; intensity: 0.8" position="0 1 0"></a-entity>

    <a-entity id="tgt-cheb" mindar-image-target="targetIndex: 0">
      <a-entity id="orange-rain" position="0 1 0"></a-entity>
    </a-entity>

    <a-entity id="tgt-shapo" mindar-image-target="targetIndex: 1">
      <a-cone id="lariska-model" radius-bottom="0.12" height="0.25" color="#9c88ff" position="0.1 0.25 0.05"></a-cone>
    </a-entity>

    <a-entity id="tgt-volk" mindar-image-target="targetIndex: 2">
      <a-box id="hare-model" depth="0.08" height="0.14" width="0.12" color="#2ecc71" position="0.35 0.08 0.05"></a-box>
      <a-torus-knot id="moped-model" p="2" q="3" radius="0.12" radius-tubular="0.02" color="#e67e22" position="-0.35 0.08 0" visible="false"></a-torus-knot>
    </a-entity>

    <a-camera position="0 0 0"></a-camera>
  </a-scene>

  <script>
    (() => {
      const $ = s => document.querySelector(s);
      const pre = $('#preloader'), hint = $('#hint'), gate = $('#start-gate'), scene = document.querySelector('a-scene');
      const showHint=t=>{hint.textContent=t; hint.classList.remove('hidden');}; const hideHint=()=>hint.classList.add('hidden');
      const enableSnap=()=>{ const b=$('#btn-snap'); if(b) b.disabled=false; };

      const mis = () => scene.systems['mindar-image-system'];
      scene.addEventListener('loaded', ()=> console.log('[A-Frame] loaded'));
      scene.addEventListener('arReady', ()=>{ pre.classList.add('hidden'); enableSnap(); console.log('[MindAR] arReady'); });
      scene.addEventListener('arError', (e)=>{ pre.classList.add('hidden'); console.error('[MindAR] arError', e?.detail||e); showHint('–ö–∞–º–µ—Ä–∞ –Ω–µ —Å—Ç–∞—Ä—Ç–æ–≤–∞–ª–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –¥—Ä—É–≥–æ–π —Ä–µ–∂–∏–º –≤—ã—à–µ.'); if(!document.body.contains(gate)) document.body.appendChild(gate); });

      // 1) –ø—Ä–µ—Ñ–ª–∞–π—Ç: –ø—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ getUserMedia —Ä–µ–∞–ª—å–Ω–æ –¥–∞—ë—Ç –ø–æ—Ç–æ–∫, –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—ã—Ä–æ–π <video> (–¥–ª—è –æ—Ç–ª–∞–¥–∫–∏)
      async function probeAndPreview(facingMode) {
        try {
          const stream = await navigator.mediaDevices.getUserMedia({video:{facingMode, width:{ideal:1280}, height:{ideal:720}}});
          const v = $('#rawvideo'); v.srcObject = stream; await v.play();
          // –ø–æ–∫–∞–∂–µ–º —Å—ã—Ä–æ–µ –≤–∏–¥–µ–æ –Ω–∞ 1.5—Å, —á—Ç–æ–±—ã —É–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –∫–∞–º–µ—Ä–∞ –¥–∞—ë—Ç –∫–∞—Ä—Ç–∏–Ω–∫—É
          v.style.display = 'block'; setTimeout(()=>{ v.style.display='none'; stream.getTracks().forEach(t=>t.stop()); v.srcObject=null; }, 1500);
          return true;
        } catch(e) {
          console.warn('probe fail', facingMode, e.name, e.message);
          return e;
        }
      }

      // 2) –∑–∞–ø—É—Å–∫ MindAR + –∞–≤—Ç–æ-—Ä–µ—Ç—Ä–∞–∏ –∏ ¬´–ø–æ–∫–∞–∑ —Å—ã—Ä–æ–≥–æ –≤–∏–¥–µ–æ¬ª, –µ—Å–ª–∏ –ø–æ-–ø—Ä–µ–∂–Ω–µ–º—É —á—ë—Ä–Ω—ã–π —ç–∫—Ä–∞–Ω
      async function startAR(facingMode){
        hideHint(); pre.classList.remove('hidden');
        // –ø—Ä–µ—Ñ–ª–∞–π—Ç ‚Äî –µ—Å–ª–∏ –¥–∞–∂–µ gUM –ø–∞–¥–∞–µ—Ç, –º–Ω–µ —Å–º—ã—Å–ª–∞ —Å—Ç–∞—Ä—Ç–æ–≤–∞—Ç—å MindAR –Ω–µ—Ç
        const probe = await probeAndPreview(facingMode);
        if (probe !== true) {
          pre.classList.add('hidden');
          showHint(`–ö–∞–º–µ—Ä–∞ (${facingMode}) –Ω–µ –∑–∞–ø—É—Å—Ç–∏–ª–∞—Å—å: ${probe.name||'Error'}. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –¥—Ä—É–≥–æ–π —Ä–µ–∂–∏–º.`);
          if(!document.body.contains(gate)) document.body.appendChild(gate);
          return;
        }
        try {
          await mis().stop?.();
        } catch {}
        try {
          await mis().start({ facingMode });
          // —á–µ—Ä–µ–∑ 3—Å –ø—Ä–æ–≤–µ—Ä–∏–º, –ø—Ä–∏—à–ª–æ –ª–∏ –≤–∏–¥–µ–æ –≤ MindAR; –µ—Å–ª–∏ –Ω–µ—Ç ‚Äî –∞–≤—Ç–æ-–ø–µ—Ä–µ–∫–ª—é—á–∏–º—Å—è
          setTimeout(()=> {
            const v = mis().video || mis()._video;
            const w = v?.videoWidth||0, h=v?.videoHeight||0;
            console.log('[MindAR video size]', w, h);
            if (w===0 || h===0) {
              console.warn('MindAR video is 0x0 ‚Äî retry with alternate camera');
              mis().stop?.();
              const alt = (facingMode==='environment')?'user':'environment';
              startAR(alt);
            }
          }, 3000);
        } catch (err) {
          console.error('start() failed', err);
          pre.classList.add('hidden');
          showHint('–°—Ç–∞—Ä—Ç –Ω–µ —É–¥–∞–ª—Å—è. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –¥—Ä—É–≥–æ–π —Ä–µ–∂–∏–º –∏–ª–∏ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ.');
          if(!document.body.contains(gate)) document.body.appendChild(gate);
        }
      }

      $('#btn-start-back').addEventListener('click', ()=>{ gate.remove(); startAR('environment'); });
      $('#btn-start-front').addEventListener('click', ()=>{ gate.remove(); startAR('user'); });

      // UI
      $('#btn-help').addEventListener('click', ()=>{
        alert('–ï—Å–ª–∏ —á—ë—Ä–Ω—ã–π —ç–∫—Ä–∞–Ω: 1) –∑–∞–∫—Ä–æ–π—Ç–µ –¥—Ä—É–≥–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è/–≤–∫–ª–∞–¥–∫–∏ —Å –∫–∞–º–µ—Ä–æ–π, 2) –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –¥—Ä—É–≥–æ–π —Ä–µ–∂–∏–º (–∑–∞–¥–Ω—è—è/—Ñ—Ä–æ–Ω—Ç–∞–ª—å–Ω–∞—è), 3) –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ.');
      });

      // –°–Ω–∏–º–æ–∫
      $('#btn-snap').addEventListener('click', async ()=>{
        const c = document.querySelector('canvas');
        if(!c){ alert('–ö–∞–º–µ—Ä–∞ –µ—â—ë –Ω–µ –≥–æ—Ç–æ–≤–∞'); return; }
        const url = c.toDataURL('image/jpeg', 0.95);
        try{
          const blob = await (await fetch(url)).blob();
          const file = new File([blob], 'souzmult-ar.jpg', {type:'image/jpeg'});
          if (navigator.canShare?.({files:[file]})) { await navigator.share({files:[file],title:'AR —Ñ–æ—Ç–æ'}); return; }
        }catch{}
        const a=document.createElement('a'); a.href=url; a.download='souzmult-ar.jpg'; a.click();
      });

      // –ö–æ–Ω—Ç–µ–Ω—Ç (–∞–Ω–∏–º–∞—Ü–∏–∏)
      const rnd=(a,b)=> a+Math.random()*(b-a);
      const orangeContainer=document.getElementById('orange-rain'); let rainTimer=null, count=0; const CAP=40;
      function spawnOrange(){ if(!orangeContainer||count>=CAP) return;
        const o=document.createElement('a-sphere'); o.setAttribute('radius', rnd(0.04,0.08)); o.setAttribute('material','color: orange; metalness:0.05; roughness:0.9');
        const x=rnd(-0.5,0.5), y=rnd(0.8,1.4), z=rnd(-0.4,0.4); o.setAttribute('position', `${x} ${y} ${z}`);
        const dur=Math.floor(rnd(1600,2600)); o.setAttribute('animation__fall', `property: position; to: ${x} -0.5 0; dur: ${dur}; easing: linear; loop: false`);
        o.addEventListener('animationcomplete__fall', ()=>{ o.remove(); count=Math.max(0,count-1); }); orangeContainer.appendChild(o); count++;
      }
      function bind(id, {tip,onFound,onLost}){ const el=document.getElementById(id); if(!el) return;
        el.addEventListener('targetFound', ()=>{ showHint(tip); onFound&&onFound(); });
        el.addEventListener('targetLost',  ()=>{ hideHint(); onLost&&onLost(); });
      }
      bind('tgt-cheb',{ tip:'–ß–µ–±—É—Ä–∞—à–∫–∞ ‚Äî –ª–æ–≤–∏—Ç–µ –∞–ø–µ–ª—å—Å–∏–Ω–∫–∏! üçä',
        onFound(){ if(!rainTimer) rainTimer=setInterval(spawnOrange,260); },
        onLost(){ if(rainTimer){ clearInterval(rainTimer); rainTimer=null; } count=0; if(orangeContainer) orangeContainer.innerHTML=''; }
      });
      const lariska=document.getElementById('lariska-model');
      lariska?.addEventListener('click', ()=>{ lariska.setAttribute('animation__wave','property: rotation; to: 0 45 0; dir: alternate; dur: 350; loop: 4; easing: easeInOutSine'); setTimeout(()=> lariska.removeAttribute('animation__wave'), 1600); });
      bind('tgt-shapo',{ tip:'–õ–∞—Ä–∏—Å–∫–∞ —Ä—è–¥–æ–º ‚Äî –Ω–∞–∂–º–∏, —á—Ç–æ–±—ã –ø–æ–º–∞—Ö–∞–ª–∞ üê≠', onFound(){}, onLost(){} });
      const moped=document.getElementById('moped-model'), hare=document.getElementById('hare-model'); let volkActive=false;
      document.getElementById('tgt-volk').addEventListener('targetFound', ()=> volkActive=true);
      document.getElementById('tgt-volk').addEventListener('targetLost',  ()=> volkActive=false);
      hare?.addEventListener('click', ()=>{ hare.setAttribute('animation__hop','property: position; to: 0.35 0.16 0.05; dir: alternate; dur: 250; loop: 2; easing:easeOutQuad'); setTimeout(()=> hare.removeAttribute('animation__hop'), 700); });
      scene.addEventListener('click', (e)=>{ const ui=document.getElementById('ui'); if (ui.contains(e.target)) return; if (!moped || !volkActive) return; const vis = moped.getAttribute('visible'); moped.setAttribute('visible', !(vis===true || vis==='true')); });
    })();
  </script>
</body>
</html>
